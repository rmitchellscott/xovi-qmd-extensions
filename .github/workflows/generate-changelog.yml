name: Generate Changelog

on:
  push:
    branches:
      - main
    paths:
      - '3.*/**/*.qmd'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find highest version
        id: find-version
        run: |
          HIGHEST_VERSION=$(ls -d */ 2>/dev/null | grep -E '^[0-9]+\.[0-9]+/$' | sed 's/\///' | sort -t. -k1,1n -k2,2n | tail -1)
          if [ -z "$HIGHEST_VERSION" ]; then
            echo "No version folders found"
            exit 1
          fi
          echo "Found highest version: $HIGHEST_VERSION"
          echo "version=$HIGHEST_VERSION" >> $GITHUB_OUTPUT

      - name: Update changelog
        env:
          VERSION: ${{ steps.find-version.outputs.version }}
        run: |
          CHANGELOG="CHANGELOG.md"
          if [ ! -f "$CHANGELOG" ]; then
            printf "# Changelog\n\n" > "$CHANGELOG"
          fi

          # Get files changed in this commit (only .qmd files in highest version)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep "^$VERSION/.*\.qmd$" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No .qmd files changed in $VERSION"
            exit 0
          fi

          # Get commit message (cleaned up)
          MSG=$(git log -1 --format="%s" | sed -E 's/ \[[^]]*\]$//; s/ \(#[0-9]*\)$//; s/^([a-z]*)\([^)]*\): /\1: /')

          # Skip docs commits
          if echo "$MSG" | grep -q "^docs:"; then
            echo "Skipping docs commit"
            exit 0
          fi

          # Process each changed file
          for file in $CHANGED_FILES; do
            FILENAME=$(basename "$file")

            # Get Modified timestamp from file
            MODIFIED=$(grep -m1 "^; Modified:" "$file" 2>/dev/null | sed 's/^; Modified: //' | xargs || echo "")

            if [ -z "$MODIFIED" ]; then
              echo "No Modified timestamp in $file, skipping"
              continue
            fi

            if grep -q "^## $FILENAME$" "$CHANGELOG"; then
              # Insert after the ## heading
              printf "#### %s\n- %s\n" "$MODIFIED" "$MSG" > entry.tmp
              sed -i "/^## $FILENAME$/r entry.tmp" "$CHANGELOG"
            else
              # Add new section after # Changelog header
              printf "\n## %s\n#### %s\n- %s\n" "$FILENAME" "$MODIFIED" "$MSG" > entry.tmp
              sed -i "/^# Changelog$/r entry.tmp" "$CHANGELOG"
            fi
            rm -f entry.tmp
          done

          echo "Updated $CHANGELOG"

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update changelog"
            git push
          fi
