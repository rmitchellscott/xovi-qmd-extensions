name: QMD Compatibility Table

on:
  push:
    branches:
      - main
    paths:
      - '3.*/**/*.qmd'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  table:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find highest semver folder
        id: find-version
        run: |
          HIGHEST_VERSION=$(ls -d */ 2>/dev/null | grep -E '^[0-9]+\.[0-9]+/$' | sed 's/\///' | sort -t. -k1,1n -k2,2n | tail -1)
          if [ -z "$HIGHEST_VERSION" ]; then
            echo "No version folders found"
            exit 1
          fi
          echo "Found highest version: $HIGHEST_VERSION"
          echo "version=$HIGHEST_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requests
        run: |
          pip install requests

      - name: Generate table
        env:
          VERSION: ${{ steps.find-version.outputs.version }}
        run: |
          cat > table.py << 'SCRIPT'
          import os
          import time
          from enum import Enum
          
          import requests
          
          
          class Status(Enum):
              NONE = '-'
              OK = '✅'
              WARNING = '⚠️'
              ERROR = '❌'
          
          
          version = os.getenv('VERSION')
          
          qmd_files = [
              os.path.join(version, file)
              for file in os.listdir(version)
              if file.endswith(".qmd")
          ]
          
          if len(qmd_files) == 0:
              print(f'No .qmd files found in {version}')
              exit(1)
          
          print(f'Found {len(qmd_files)} QMD files in {version}/')
          print('Files:', ', '.join([os.path.basename(file) for file in qmd_files]))
          
          url = 'https://qmdverify.scottlabs.io/api/compare'
          
          files = []
          for file in qmd_files:
              filename = os.path.basename(file)
              files.append(('files', (filename, open(file, 'rb'))))
              files.append(('paths', (None, filename)))
          
          print('Uploading files...')
          
          response = requests.post(url, files=files)
          response.raise_for_status()
          job_id = response.json()['jobId']
          
          print('Waiting for results...')
          
          while True:
              response = requests.get(f'https://qmdverify.scottlabs.io/api/results/{job_id}')
              response.raise_for_status()
              results = response.json()
          
              if 'status' in results and results['status'] == 'pending':
                  time.sleep(3)
                  continue
          
              break
          
          print('Rendering the table...')
          
          table = '''
          | File | reMarkable 1 | reMarkable 2 | Paper Pro | Paper Pro Move |
          | ---- | ------------ | ------------ | --------- | -------------- |
          '''
          
          for file, result in results.items():
              devices = {
                  'rm1': Status.NONE,
                  'rm2': Status.NONE,
                  'rmpp': Status.NONE,
                  'rmppm': Status.NONE
              }
          
              for hashtable in result['compatible']:
                  device = hashtable['device']
                  if not hashtable['os_version'].startswith(f'{version}.'):
                      continue
          
                  devices[device] = Status.OK
          
              for hashtable in result['incompatible']:
                  device = hashtable['device']
                  if not hashtable['os_version'].startswith(f'{version}.'):
                      continue
          
                  if devices[device] == Status.OK:
                      devices[device] = Status.WARNING
                  elif devices[device] == Status.NONE:
                      devices[device] = Status.ERROR
          
              table += f'| {file} |'
              for status in devices.values():
                  table += f' {status.value} |'
              table += '\n'
          
          print('Updating the README...')
          
          start_marker = '<!-- compat:begin -->'
          end_marker = '<!-- compat:end -->'
          
          with open('README.MD') as f:
              readme = f.read()
          
          start = readme.index(start_marker)
          end = readme.index(end_marker)
          
          readme = readme[:start + len(start_marker)] + table + readme[end:]
          
          with open('README.MD', 'w') as f:
              f.write(readme)

          SCRIPT

          python table.py

      - name: Commit table
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.MD

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update compatibility table for ${{ steps.find-version.outputs.version }}"
            git push
          fi
