; Mitchell Scott (https://github.com/rmitchellscott)
; SPDX-License-Identifier: MIT
; Modified: 2025-12-23T19:10:11Z
;
; To use with rmhacks:
; 1. place this qmd in /home/root/xovi/exthome/qt-resource-rebuilder/rmitchellscott/notebookToc.qmd
; 2. in /home/root/xovi/exthome/qt-resource-rebuilder/zz_rmhacks.qmd, add 
;    LOAD rmitchellscott/notebookToc.qmd
;    after the line LOAD rmHacks/bookmarks.qmd
; 3. comment out LOAD rmHacks/table_of_contents_button_hack.qmd by placing a ; in front of it

AFFECT [[1658694193319203921]]
    TRAVERSE [[6502786168]]
        LOCATE AFTER ALL INSERT {
            readonly property ~&7083178290016&~ tocFilePath: "file:///home/root/.local/share/remarkable/xochitl/%1/toc.rm"
            readonly property ~&7083178290016&~ tocRmHeader: "reMarkable .lines file, version=6          "

            function tocReadEntries(~&8399386052748489877&~, ~&7712874493159382&~) {
                ~&214622607920&~ req =    new    XMLHttpRequest();
                req.~&6504147419&~("GET", tocFilePath.~&197080195&~(~&8399386052748489877&~));
                req.onreadystatechange = () => {
                    ~&5972376&~ (req.readyState === XMLHttpRequest.DONE) {
                        try {
                            ~&214622607920&~ ~&6504315758&~ = req.responseText || "";
                            ~&214622607920&~ jsonStart = ~&6504315758&~.~&233731717342038&~("{");
                            ~&5972376&~ (jsonStart >= 0) {
                                ~&7712874493159382&~(~&6502785411&~.~&214637526116&~(~&6504315758&~.~&254548200562243306&~(jsonStart)));
                            } ~&6503784146&~ {
                                ~&7712874493159382&~(~&6504117156&~);
                            }
                        } catch (~&180974&~) {
                            ~&7712874493159382&~(~&6504117156&~);
                        }
                    }
                };
                req.~&6504279475&~();
            }

            function tocWriteEntries(~&8399386052748489877&~, tocData) {
                ~&214622607920&~ req =    new    XMLHttpRequest();
                req.~&6504147419&~("PUT", tocFilePath.~&197080195&~(~&8399386052748489877&~));
                req.~&6504279475&~(tocRmHeader + ~&6502785411&~.~&254548178208422824&~(tocData));
            }

            function tocClearEntries(~&8399386052748489877&~) {
                ~&214622607920&~ req =    new    XMLHttpRequest();
                req.~&6504147419&~("PUT", tocFilePath.~&197080195&~(~&8399386052748489877&~));
                req.~&6504279475&~(tocRmHeader + "[cleared:" + ~&8399386052748489877&~ + ~&"180966&~);
            }
        }
    END TRAVERSE
END AFFECT

AFFECT [[1224665461898798997]]
    TRAVERSE [[8397993708429497603]]
        LOCATE BEFORE ALL
        INSERT {
            property ~&197102514&~ tocEntries: ({})
            property bool tocLoading: ~&214625660372&~
            property ~&197102514&~ _nativeTocModel: []

            function tocLoadEntries() {
                tocLoading = ~&6504329801&~;
                tocEntries = ({});
                ~&5972376&~ (!~&7712934851008712&~) {
                    tocLoading = ~&214625660372&~;
                    tocBuildModel();
                    ~&7083121450889&~;
                }

                ~&7082020628281&~.tocReadEntries(~&7712934851008712&~.~&5972374&~, (~&6503736259&~) => {
                    ~&214622607920&~ entries = ({});

                    ~&5972376&~ (!!~&6503736259&~) {
                        ~&197085552&~ (~&214622607920&~ [~&197090674&~, ~&197094916&~] ~&5972574&~ ~&7081747777088&~.entries(~&6503736259&~)) {
                            ~&197091758&~ isValid = ~&214625660372&~;

                            ~&5972376&~ (~&197090674&~.startsWith("p:")) {
                                ~&214622607920&~ ratio = parseFloat(~&197090674&~.~&254548200562243306&~(2));
                                isValid = ratio >= 0 && ratio <= 1;
                            } ~&6503784146&~ ~&5972376&~ (!~&214629831714&~(~&7081731278802&~(~&197090674&~))) {
                                isValid = ~&6504329801&~;
                            } ~&6503784146&~ {
                                isValid = ~&7712934851008712&~.pageForId(~&197090674&~) >= 0;
                            }

                            ~&5972376&~ (isValid) {
                                entries[~&197090674&~] = { ~&6504095402&~: ~&197094916&~.~&6504095402&~ || "", ~&214632930081&~: ~&197094916&~.~&214632930081&~ ?? 0 };
                            }
                        }
                        tocEntries = entries;
                    }

                    tocLoading = ~&214625660372&~;
                });
            }

            function tocSaveEntries() {
                ~&5972376&~ (!~&7712934851008712&~ || tocLoading) ~&7083121450889&~;
                ~&5972376&~ (~&7081747777088&~.~&6503992357&~(tocEntries).~&7082886407723&~ === 0) {
                    ~&7082020628281&~.tocClearEntries(~&7712934851008712&~.~&5972374&~);
                } ~&6503784146&~ {
                    ~&7082020628281&~.tocWriteEntries(~&7712934851008712&~.~&5972374&~, tocEntries);
                }
            }

            function tocAddEntry(~&7083037950451&~, ~&6504095402&~) {
                ~&197091758&~ ~&197090674&~, ~&6504167078&~;

                ~&5972376&~ (~&7712934851008712&~.~&7713012671454059&~ === ~&7711571060833448&~.~&214586564057&~) {
                    ~&6504167078&~ = ~&15793094956877902211&~.~&477346483278306569&~;

                    ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&6504167078&~)) {
                        ~&197090674&~ = ~&7083037950451&~;
                    } ~&6503784146&~ {
                        ~&197091758&~ notesBefore = 0;
                        ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&6504167078&~; ~&180978&~++) {
                            ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) notesBefore++;
                        }
                        ~&214622607920&~ originalPageNumber = ~&6504167078&~ - notesBefore;

                        ~&197091758&~ totalNotes = 0;
                        ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&7712934851008712&~.~&254543134818768527&~; ~&180978&~++) {
                            ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) totalNotes++;
                        }
                        ~&214622607920&~ originalPageCount = ~&7712934851008712&~.~&254543134818768527&~ - totalNotes;

                        ~&214622607920&~ ratio = originalPageCount > 1
                            ? originalPageNumber / (originalPageCount - 1)
                            : 0;
                        ~&197090674&~ = "p:" + ratio.~&233745927191932&~(6);
                    }
                } ~&6503784146&~ {
                    ~&197090674&~ = ~&7083037950451&~;
                    ~&6504167078&~ = ~&7712934851008712&~.pageForId(~&7083037950451&~);
                }

                ~&5972376&~ (~&6504167078&~ < 0) ~&7083121450889&~;

                ~&197091758&~ inheritedLevel = 0;
                ~&197085552&~ (~&214622607920&~ ~&214624950331&~ ~&5972574&~ ~&15793094956877902211&~.~&7713616698729984&~) {
                    ~&5972376&~ (~&214624950331&~.~&6504167078&~ <= ~&6504167078&~) {
                        inheritedLevel = ~&214624950331&~.~&214632930081&~ ?? 0;
                    } ~&6503784146&~ {
                        ~&214621519406&~;
                    }
                }
                tocEntries[~&197090674&~] = { ~&6504095402&~: ~&6504095402&~ || "", ~&214632930081&~: inheritedLevel };
                tocEntriesChanged();
            }

            function tocDeleteEntry(~&7083037950451&~) {
                ~&5972376&~ (tocEntries[~&7083037950451&~]) {
                    ~&7082573250524&~ tocEntries[~&7083037950451&~];
                    tocEntriesChanged();
                }
            }

            function tocShowRenameDialog(~&7083037950451&~) {
                ~&197091758&~ ~&197090674&~, ~&6504167078&~;

                ~&5972376&~ (~&7712934851008712&~.~&7713012671454059&~ === ~&7711571060833448&~.~&214586564057&~) {
                    ~&6504167078&~ = ~&15793094956877902211&~.~&477346483278306569&~;

                    ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&6504167078&~)) {
                        ~&197090674&~ = ~&7083037950451&~;
                    } ~&6503784146&~ {
                        ~&197091758&~ notesBefore = 0;
                        ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&6504167078&~; ~&180978&~++) {
                            ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) notesBefore++;
                        }
                        ~&214622607920&~ originalPageNumber = ~&6504167078&~ - notesBefore;

                        ~&197091758&~ totalNotes = 0;
                        ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&7712934851008712&~.~&254543134818768527&~; ~&180978&~++) {
                            ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) totalNotes++;
                        }
                        ~&214622607920&~ originalPageCount = ~&7712934851008712&~.~&254543134818768527&~ - totalNotes;

                        ~&214622607920&~ ratio = originalPageCount > 1
                            ? originalPageNumber / (originalPageCount - 1)
                            : 0;
                        ~&197090674&~ = "p:" + ratio.~&233745927191932&~(6);
                    }
                } ~&6503784146&~ {
                    ~&197090674&~ = ~&7083037950451&~;
                    ~&6504167078&~ = ~&7712934851008712&~.pageForId(~&7083037950451&~);
                }

                ~&214622607920&~ ~&6504095402&~ = tocEntries[~&197090674&~]?.~&6504095402&~ || "";
                _tocRenamePopup.~&6504147419&~(~&197090674&~, ~&6504095402&~, ~&6504167078&~);
            }

            function tocRenameEntry(~&7083037950451&~, ~&6504095402&~) {
                ~&214622607920&~ existingLevel = tocEntries[~&7083037950451&~]?.~&214632930081&~ ?? 0;
                tocEntries[~&7083037950451&~] = { ~&6504095402&~: ~&6504095402&~, ~&214632930081&~: existingLevel };
                tocEntriesChanged();
            }

            function tocSetEntryLevel(~&7083037950451&~, ~&214632930081&~) {
                ~&5972376&~ (tocEntries[~&7083037950451&~]) {
                    tocEntries[~&7083037950451&~].~&214632930081&~ = ~&6502909715&~.~&197092719&~(0, ~&214632930081&~);
                    tocEntriesChanged();
                }
            }

            function tocRevalidateEntries() {
                ~&7081747777088&~.~&6503992357&~(tocEntries).~&233727897502049&~((~&197090674&~) => {
                    ~&197091758&~ isValid = ~&214625660372&~;

                    ~&5972376&~ (~&197090674&~.startsWith("p:")) {
                        ~&214622607920&~ ratio = parseFloat(~&197090674&~.~&254548200562243306&~(2));
                        isValid = ratio >= 0 && ratio <= 1;
                    } ~&6503784146&~ ~&5972376&~ (!~&214629831714&~(~&7081731278802&~(~&197090674&~))) {
                        ~&214622607920&~ pageNum = ~&7081731278802&~(~&197090674&~);
                        isValid = pageNum >= 0 && pageNum < ~&7712934851008712&~.~&254543134818768527&~;
                    } ~&6503784146&~ {
                        isValid = ~&7712934851008712&~.pageForId(~&197090674&~) >= 0;
                    }

                    ~&5972376&~ (!isValid) {
                        ~&7082573250524&~ tocEntries[~&197090674&~];
                    }
                });
                tocEntriesChanged();
            }

            function tocBuildModel() {
                ~&5972376&~ (!~&7712934851008712&~) {
                    ~&15793094956877902211&~.~&7713616698729984&~ = [];
                    ~&7083121450889&~;
                }
                ~&197091758&~ entries = [];

                ~&5972376&~ (~&7712934851008712&~.~&7713012671454059&~ !== ~&7711571060833448&~.~&7711997891205770&~ && ~&15793094956877902211&~._nativeTocModel) {
                    ~&197085552&~ (~&214622607920&~ ~&214624950331&~ ~&5972574&~ ~&15793094956877902211&~._nativeTocModel) {
                        entries.~&6504189257&~({
                            ~&6504167078&~: ~&214624950331&~.~&6504167078&~,
                            ~&6504095402&~: ~&214624950331&~.~&6504095402&~,
                            ~&214632930081&~: ~&214624950331&~.~&214632930081&~ ?? 0,
                            isUserEntry: ~&214625660372&~
                        });
                    }
                }

                ~&197085552&~ (~&214622607920&~ [~&197090674&~, ~&6503736259&~] ~&5972574&~ ~&7081747777088&~.entries(tocEntries)) {
                    ~&197091758&~ ~&6504167078&~;

                    ~&5972376&~ (~&197090674&~.startsWith("p:")) {
                        ~&214622607920&~ ratio = parseFloat(~&197090674&~.~&254548200562243306&~(2));

                        ~&5972376&~ (~&7712934851008712&~.~&7713012671454059&~ === ~&7711571060833448&~.~&214586564057&~) {
                            ~&197091758&~ totalNotes = 0;
                            ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&7712934851008712&~.~&254543134818768527&~; ~&180978&~++) {
                                ~&5972376&~ (~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) totalNotes++;
                            }
                            ~&214622607920&~ originalPageCount = ~&7712934851008712&~.~&254543134818768527&~ - totalNotes;
                            ~&214622607920&~ originalPageNumber = originalPageCount > 1
                                ? ~&6502909715&~.~&214640404177&~(ratio * (originalPageCount - 1))
                                : 0;

                            ~&197091758&~ originalsSeen = 0;
                            ~&6504167078&~ = -1;
                            ~&197085552&~ (~&197091758&~ ~&180978&~ = 0; ~&180978&~ < ~&7712934851008712&~.~&254543134818768527&~; ~&180978&~++) {
                                ~&5972376&~ (!~&7712934851008712&~.~&8399622833342862200&~(~&180978&~)) {
                                    ~&5972376&~ (originalsSeen === originalPageNumber) {
                                        ~&6504167078&~ = ~&180978&~;
                                        ~&214621519406&~;
                                    }
                                    originalsSeen++;
                                }
                            }
                        } ~&6503784146&~ {
                            ~&6504167078&~ = ~&7712934851008712&~.~&254543134818768527&~ > 1
                                ? ~&6502909715&~.~&214640404177&~(ratio * (~&7712934851008712&~.~&254543134818768527&~ - 1))
                                : 0;
                        }
                    } ~&6503784146&~ ~&5972376&~ (!~&214629831714&~(~&7081731278802&~(~&197090674&~))) {
                        ~&6504167078&~ = ~&7081731278802&~(~&197090674&~);
                    } ~&6503784146&~ {
                        ~&6504167078&~ = ~&7712934851008712&~.pageForId(~&197090674&~);
                    }

                    ~&5972376&~ (~&6504167078&~ >= 0 && ~&6504167078&~ < ~&7712934851008712&~.~&254543134818768527&~) {
                        entries.~&6504189257&~({
                            ~&6504167078&~: ~&6504167078&~,
                            ~&7083037950451&~: ~&197090674&~,
                            ~&6504095402&~: ~&6503736259&~.~&6504095402&~ || ("Page " + (~&6504167078&~ + 1)),
                            ~&214632930081&~: ~&6503736259&~.~&214632930081&~ ?? 0,
                            isUserEntry: ~&6504329801&~
                        });
                    }
                }

                entries.~&6504290513&~((~&180970&~, ~&180971&~) => ~&180970&~.~&6504167078&~ - ~&180971&~.~&6504167078&~);
                ~&15793094956877902211&~.~&7713616698729984&~ = entries;
            }

            property ~&197102514&~ _savedTocScrollPosition: ~&6504117156&~

            function tocShowView() {
                tocBuildModel();
                ~&5972376&~ (~&254547437090201330&~ && ~&254547437090201330&~.~&502817364213021138&~) {
                    _savedTocScrollPosition = {
                        ~&7082534202858&~: ~&5971598&~.~&214638019283&~(~&254547437090201330&~.~&502817364213021138&~.~&7082534202858&~.~&180993&~, ~&254547437090201330&~.~&502817364213021138&~.~&7082534202858&~.~&180994&~),
                        ~&214641137009&~: ~&254547437090201330&~.~&502817364213021138&~.~&214641137009&~
                    };
                }
                ~&214637513689&~.tocFromToolbar = ~&6504329801&~;
                ~&214637513689&~.~&233748328658231&~ = ~&6504329801&~;
                ~&214637513689&~.tocShowView(~&6504329801&~);
            }

            function tocRestoreScrollPosition() {
                ~&5972376&~ (_savedTocScrollPosition && ~&254547437090201330&~ && ~&254547437090201330&~.~&502817364213021138&~) {
                    ~&254547437090201330&~.~&502817364213021138&~.setFocalPoint(_savedTocScrollPosition.~&7082534202858&~, _savedTocScrollPosition.~&214641137009&~);
                    _savedTocScrollPosition = ~&6504117156&~;
                }
            }

            onTocEntriesChanged: {
                tocSaveEntries();
                tocBuildModel();
            }
        }

        TRAVERSE [[6502786168]]#[[15549782143769420265]]
            TRAVERSE [[233704648923420]]
                LOCATE BEFORE ALL INSERT {
                    onTocShowView: ~&15793094956877902211&~.tocShowView()
                    onTocAddEntry: (~&7083037950451&~) => {
                        ~&15793094956877902211&~.tocShowRenameDialog(~&7083037950451&~);
                    }
                    onTocAddCurrentEntry: {
                        ~&15793094956877902211&~.tocShowRenameDialog(~&15793094956877902211&~.~&3321486226208410902&~);
                    }
                }
            END TRAVERSE
        END TRAVERSE

        REPLACE [[13184053911240945935]] WITH {
            ~&13184053911240945935&~: {
                ~&5972376&~ (!!~&7712934851008712&~){
                    ~&15793094956877902211&~.~&2905125091891814744&~();
                    tocLoadEntries();
                }
            }
        }

        TRAVERSE [[428051690305612204]][.[[7083194890448]]=[[7712934851008712]]]
            ASSERT [[927074197512191160]]

            REBUILD [[927074197512191160]]
                LOCATE BEFORE ALL
                INSERT {
                    ~&5972376&~ (~&7712934851008712&~ && ~&7712934851008712&~.~&7713012671454059&~ === ~&7711571060833448&~.~&7711997891205770&~) ~&7083121450889&~;
                    ~&15793094956877902211&~._nativeTocModel = results || [];
                    ~&15793094956877902211&~.tocBuildModel();
                }
            END REBUILD

            REBUILD [[1576309469129240203]]
                LOCATE AFTER ALL
                INSERT { ~&15793094956877902211&~.tocRevalidateEntries(); }
            END REBUILD
        END TRAVERSE

        LOCATE AFTER [[428051690305612204]][.[[7083194890448]]=[[7712934851008712]]]
        INSERT {
            ~&428051690305612204&~ {
                ~&7083194890448&~: ~&214637513689&~
                function ~&13733777459642361598&~() {
                    ~&5972376&~ (~&214637513689&~.~&233748328658231&~ && ~&7712934851008712&~ && !~&214637513689&~.tocFromToolbar) {
                        tocLoadEntries();
                    }
                }
            }
        }

        LOCATE AFTER ALL
        INSERT {
            function tocShowDeletePopup(~&7083037950451&~, ~&6504095402&~) {
                _tocDeleteLoader.~&7083037950451&~ = ~&7083037950451&~;
                _tocDeleteLoader.~&254528235724402268&~ = ~&6504095402&~;
                _tocDeleteLoader.~&7082453764421&~ = ~&6504329801&~;
            }

            ~&7081645463424&~ {
                ~&5972374&~: _tocDeleteLoader
                ~&7082453764421&~: ~&214625660372&~
                property ~&7083178290016&~ ~&7083037950451&~: ""
                property ~&7083178290016&~ ~&254528235724402268&~: ""
                ~&233721384511543&~.~&197100796&~: ~&7083038346995&~.~&197100796&~
                ~&233721384511543&~.~&6504027668&~: ~&7083038346995&~.~&6504027668&~
                ~&233721384511543&~.~&214640173127&~: ~&7083038346995&~.~&214640173127&~
                ~&180995&~: 1000

                ~&16021043814775702381&~: ~&4498845937083848685&~ {
                    ~&233748328658231&~: ~&6504329801&~
                    ~&214646099849&~: _tocDeleteLoader.~&214646099849&~
                    ~&214642559243&~: ~&6504222003&~("Delete \"%1\"?").~&197080195&~(_tocDeleteLoader.~&254528235724402268&~)
                    ~&478136262235079021&~: ~&6504222003&~("This will remove the entry from your table of contents.")
                    ~&11971920598453341784&~: ~&6504222003&~(~&"7081320917948&~)
                    ~&13523480105588542791&~: ~&6504222003&~(~&"7081277108079&~)
                    ~&8399893700003527327&~: {
                        ~&15793094956877902211&~.tocDeleteEntry(_tocDeleteLoader.~&7083037950451&~);
                        _tocDeleteLoader.~&7082453764421&~ = ~&214625660372&~;
                    }
                    ~&8399894427373474444&~: _tocDeleteLoader.~&7082453764421&~ = ~&214625660372&~
                }
            }

            ~&214600077661&~ {
                ~&5972374&~: _tocRenamePopup
                property ~&7083178290016&~ ~&7083037950451&~
                property ~&197088788&~ ~&8399923449456665295&~: 0
                ~&214646099849&~: ~&15549782143769420265&~.~&214646099849&~
                ~&233739780873643&~: ~&14839296689095546654&~

                ~&2122835675838176157&~: _tocRenameInput.~&2122835675838176157&~
                ~&17012884421348371483&~: ~&214600077661&~.~&8398624284572419691&~.~&11039320312232865459&~
                ~&11412860438186802733&~: ~&6504329801&~

                function ~&6504147419&~(pId, ~&6504095402&~, ~&6504167078&~) {
                    _tocRenamePopup.~&7083037950451&~ = pId;
                    _tocRenamePopup.~&8399923449456665295&~ = ~&6504167078&~;
                    _tocRenameInput.~&6504315758&~ = ~&6504095402&~ || "";
                    ~&254547663425316670&~();
                }

                ~&13733777459642361598&~: {
                    ~&5972376&~ (~&233748328658231&~) _tocRenameInput.~&8399617258038629437&~.~&9186019576827190292&~();
                }

                ~&435226761427665314&~ {
                    ~&5972374&~: _tocRenameInput
                    ~&496814758264239564&~: ~&6504222003&~(~&"233698925343196&~).~&197080195&~(_tocRenamePopup.~&8399923449456665295&~ + 1)
                    ~&15687297754887797348&~: ~&214625660372&~
                    ~&8399617258038629437&~.~&16881952377443810710&~: ~&7082020628281&~.~&8399340017235344933&~
                    ~&8399617258038629437&~.~&4014537309200381774&~: ~&7082020628281&~.~&8399340017260114793&~
                    ~&214626153769&~: ~&6504329801&~
                    ~&233748328658231&~: ~&6504329801&~
                    ~&477061882630366844&~: ~&6504222003&~(~&"6503125400&~)

                    ~&8399893700003527327&~: (~&6504315758&~) => {
                        ~&5972376&~ (~&6504315758&~.~&7082886407723&~) ~&15793094956877902211&~.tocAddEntry(_tocRenamePopup.~&7083037950451&~, ~&6504315758&~.~&6504329413&~());
                        _tocRenamePopup.~&254532220638374263&~();
                    }

                    ~&8399894427373474444&~: _tocRenamePopup.~&254532220638374263&~()
                }
            }
        }
    END TRAVERSE
END AFFECT

AFFECT [[4530443761526121003]]
    TRAVERSE [[8397788359424131273]]
        LOCATE BEFORE ALL
        INSERT {
            property bool tocFromToolbar: ~&214625660372&~

            function tocShowView(fromToolbar) {
                tocFromToolbar = fromToolbar || ~&214625660372&~;
                ~&13155146558357480555&~.~&7082453764421&~ = ~&6504329801&~;
            }

            function tocHandleRejected() {
                ~&5972376&~ (tocFromToolbar) {
                    tocFromToolbar = ~&214625660372&~;
                    ~&13155146558357480555&~.~&7082453764421&~ = ~&214625660372&~;
                    ~&214637513689&~.~&233748328658231&~ = ~&214625660372&~;
                    ~&15793094956877902211&~.tocRestoreScrollPosition();
                } ~&6503784146&~ {
                    ~&13155146558357480555&~.~&7082453764421&~ = ~&214625660372&~;
                }
            }
        }

        TRAVERSE [[15218691749766925454]]
            TRAVERSE [[6085114766532497432]][.[[8399601734642709923]]=[["15094524446771854124]]]
                LOCATE BEFORE ALL
                INSERT { ~&5972374&~: ~&13155146557973942704&~ }
            END TRAVERSE
        END TRAVERSE

        LOCATE AFTER [[7081645463424]]#[[13155146558357480555]]
        INSERT {
            ~&428051690305612204&~ {
                ~&7083194890448&~: ~&13155146558357480555&~.~&6503936152&~
                function ~&8399894427373474444&~() {
                    ~&214637513689&~.tocHandleRejected();
                }
                function onTocDeleteEntry(~&7083037950451&~) {
                    ~&15793094956877902211&~.tocDeleteEntry(~&7083037950451&~);
                }
                function onTocConfirmDelete(~&7083037950451&~, ~&6504095402&~) {
                    ~&15793094956877902211&~.tocShowDeletePopup(~&7083037950451&~, ~&6504095402&~);
                }
                function onTocRenameEntry(~&7083037950451&~, ~&6504095402&~) {
                    ~&15793094956877902211&~.tocRenameEntry(~&7083037950451&~, ~&6504095402&~);
                    ~&13155146558357480555&~.~&7082453764421&~ = ~&214625660372&~;
                    ~&13155146558357480555&~.~&7082453764421&~ = ~&6504329801&~;
                }
                function onTocSetLevel(~&7083037950451&~, ~&214632930081&~) {
                    ~&15793094956877902211&~.tocSetEntryLevel(~&7083037950451&~, ~&214632930081&~);
                }
            }

            ~&233681166222244&~ {
                ~&7083194890448&~: ~&2418927073359434988&~
                property: ~&"233748328658231&~
                ~&214644635174&~: !~&496312708941723703&~.~&233748328658231&~ && !~&4550470176672569638&~.~&7082453764421&~ && !~&13155146558357480555&~.~&7082453764421&~
            }

            ~&233681166222244&~ {
                ~&7083194890448&~: ~&13155146557973942704&~
                property: ~&"233748328658231&~
                ~&214644635174&~: ~&496312708941723703&~.~&14342398830733847618&~ && !~&4550470176672569638&~.~&7082453764421&~ && ~&15793094956877902211&~.~&7713616698729984&~.~&7082886407723&~
            }
        }
    END TRAVERSE
END AFFECT

AFFECT [[6554413872610298131]]
    IMPORT QtQuick.Layouts 1.0
    IMPORT xofm.libs.controls 1.0
    IMPORT ark.tokens 1.0
    TRAVERSE [[8397788359424131273]]#[[15225781669996973588]]
        LOCATE BEFORE ALL
        INSERT {
            property ~&7083178290016&~ editingPageId: ""

            signal tocDeleteEntry(~&7083178290016&~ ~&7083037950451&~)
            signal tocConfirmDelete(~&7083178290016&~ ~&7083037950451&~, ~&7083178290016&~ ~&6504095402&~)
            signal tocRenameEntry(~&7083178290016&~ ~&7083037950451&~, ~&7083178290016&~ ~&6504095402&~)
            signal tocSetLevel(~&7083178290016&~ ~&7083037950451&~, ~&197088788&~ ~&214632930081&~)

            ~&425121728314878811&~.Caption {
                ~&5972374&~: _pageWidthRef
                ~&233748328658231&~: ~&214625660372&~
                ~&6504315758&~: ~&15793094956877902211&~.~&7712934851008712&~ ? ~&15793094956877902211&~.~&7712934851008712&~.~&254543134818768527&~.~&7713616118928163&~() : ~&"180922&~
            }
        }

        TRAVERSE [[17555155952404031931]] > [[7711904883727328]]#[[15680802033737085648]]
            REPLACE [[7712922269353028]] WITH {
                ~&7712922269353028&~: ~&254501108490678590&~ {
                    ~&5972374&~: tocDelegate
                    required property ~&197102514&~ ~&254539508423767444&~
                    required property ~&197088788&~ ~&214629676161&~
                    ~&214646099849&~: ~&6504391364&~.~&214646099849&~
                    ~&7082729686082&~: ~&7082020628281&~.~&17638761292564792854&~
                    ~&214622605608&~: ~&7082020628281&~.~&8399340017260114793&~

                    readonly property bool ~&254534011279562504&~: ~&12425827111281538095&~(~&214629676161&~)
                    readonly property ~&7083178290016&~ ~&8399923449651343933&~: (~&254539508423767444&~.~&6504167078&~ + 1).~&7713616118928163&~()
                    readonly property ~&7083178290016&~ ~&254528235724402268&~: ~&254539508423767444&~.~&6504095402&~
                    readonly property ~&7083178290016&~ entryPageId: ~&254539508423767444&~.~&7083037950451&~ || ""
                    readonly property ~&197088788&~ ~&214632930081&~: ~&254539508423767444&~.~&214632930081&~ ?? 0
                    readonly property bool isUserEntry: ~&254539508423767444&~.isUserEntry === ~&6504329801&~
                    readonly property bool isEditing: isUserEntry && ~&15225781669996973588&~.editingPageId === entryPageId

                    ~&254501558939456351&~ {
                        ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                        ~&233721384511543&~.~&8399743405844438450&~: ~&214632930081&~ * 50
                        ~&233721384511543&~.~&499747351624466981&~: ~&7082020628281&~.~&13257341367876254&~
                        ~&233744706647566&~: ~&7082020628281&~.~&8260768964620614264&~

                        ~&3313440495918644137&~ {
                            ~&5972374&~: nameLabel
                            ~&7081629735527&~.~&254529418434902000&~: ~&6504329801&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~
                            ~&214624865996&~: ~&6503165774&~.~&430968154721198747&~
                            ~&6504315758&~: ~&254528235724402268&~
                            ~&6503823200&~.~&6503679370&~: ~&254534011279562504&~
                            ~&233748328658231&~: !tocDelegate.isEditing

                            ~&254494525842443467&~ {
                                ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                                ~&254542236275632405&~: {
                                    ~&15225781669996973588&~.~&13277909919941986047&~(~&254539508423767444&~.~&6504167078&~);
                                }
                                ~&383135108587212173&~: {
                                    ~&5972376&~ (tocDelegate.isUserEntry && entryPageId) {
                                        ~&15225781669996973588&~.editingPageId = entryPageId;
                                        nameInput.~&6504315758&~ = ~&254528235724402268&~;
                                        nameInput.~&9186019576827190292&~();
                                        nameInput.~&254547531013807458&~();
                                    }
                                }
                            }
                        }

                        ~&17480428514224686268&~ {
                            ~&5972374&~: nameInput
                            ~&7081629735527&~.~&254529418434902000&~: ~&6504329801&~
                            ~&233748328658231&~: tocDelegate.isEditing
                            ~&6503823200&~.~&254543497768871654&~: ~&7082020628281&~.~&8015843119099583226&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~

                            ~&8399893700003527327&~: {
                                ~&5972376&~ (~&6504315758&~.~&6504329413&~().~&7082886407723&~ > 0) {
                                    ~&15225781669996973588&~.tocRenameEntry(entryPageId, ~&6504315758&~.~&6504329413&~());
                                }
                                ~&15225781669996973588&~.editingPageId = "";
                            }

                            ~&18319773372398057328&~: {
                                ~&5972376&~ (!~&214626153769&~ && tocDelegate.isEditing) {
                                    ~&15225781669996973588&~.editingPageId = "";
                                }
                            }

                            ~&6502842373&~.onEscapePressed: {
                                ~&15225781669996973588&~.editingPageId = "";
                            }
                        }

                        ~&425121728314878811&~.~&6502767986&~ {
                            ~&7081629735527&~.~&254522510204479688&~: ~&5971598&~.~&14019785292674113803&~
                            ~&233748328658231&~: tocDelegate.isUserEntry && tocDelegate.~&214632930081&~ > 0
                            ~&7083172477658&~: ~&"3792857133055099087&~
                            ~&6504284228&~: ~&7082020628281&~.~&12414259495892754182&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~

                            ~&254494525842443467&~ {
                                ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                                ~&254542236275632405&~: ~&15225781669996973588&~.tocSetLevel(entryPageId, tocDelegate.~&214632930081&~ - 1)
                            }
                        }

                        ~&425121728314878811&~.~&6502767986&~ {
                            ~&7081629735527&~.~&254522510204479688&~: ~&5971598&~.~&14019785292674113803&~
                            ~&233748328658231&~: tocDelegate.isUserEntry
                            ~&7083172477658&~: ~&"14483820948568220258&~
                            ~&6504284228&~: ~&7082020628281&~.~&12414259495892754182&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~

                            ~&254494525842443467&~ {
                                ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                                ~&254542236275632405&~: ~&15225781669996973588&~.tocSetLevel(entryPageId, tocDelegate.~&214632930081&~ + 1)
                            }
                        }

                        ~&425121728314878811&~.~&6502767986&~ {
                            ~&7081629735527&~.~&254522510204479688&~: ~&5971598&~.~&14019785292674113803&~
                            ~&7081629735527&~.~&8399743405844438450&~: ~&7082020628281&~.~&8260768964620614264&~
                            ~&233748328658231&~: tocDelegate.isUserEntry
                            ~&7083172477658&~: ~&"8609871989899886756&~
                            ~&6504284228&~: ~&7082020628281&~.~&12414259495892754182&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~

                            ~&254494525842443467&~ {
                                ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                                ~&254542236275632405&~: ~&15225781669996973588&~.tocConfirmDelete(entryPageId, ~&254528235724402268&~)
                            }
                        }

                        ~&425121728314878811&~.Caption {
                            ~&7081629735527&~.~&16239278111605497701&~: _pageWidthRef.~&15743061641160745028&~
                            ~&15450610953915458578&~: ~&6503165774&~.~&8397757669215083186&~
                            ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~
                            ~&6504315758&~: ~&8399923449651343933&~
                        }
                    }

                    ~&254501108490678590&~ {
                        ~&233721384511543&~.~&7082507142622&~: ~&7083038346995&~.~&7082507142622&~
                        ~&233721384511543&~.~&6504027668&~: ~&7083038346995&~.~&6504027668&~
                        ~&233721384511543&~.~&8399743405844438450&~: ~&214632930081&~ * 50
                        ~&233721384511543&~.~&214640173127&~: ~&7083038346995&~.~&214640173127&~
                        ~&7082729686082&~: ~&7082020628281&~.~&495727993356258788&~
                        ~&214622605608&~: ~&7082020628281&~.~&8399340017235344933&~
                    }

                    ~&254494525842443467&~ {
                        ~&233721384511543&~.~&6503816592&~: ~&7083038346995&~
                        ~&233726547792244&~: !tocDelegate.isUserEntry
                        ~&180995&~: -1
                        ~&254542236275632405&~: ~&15225781669996973588&~.~&13277909919941986047&~(~&254539508423767444&~.~&6504167078&~)
                    }
                }
            }
        END TRAVERSE
    END TRAVERSE
END AFFECT

; Toolbar path (3.22)
AFFECT [[2857280009207495592]]
    IMPORT xofm.libs.controls 1.0
    IMPORT QtQuick.Window 2.0
    TRAVERSE [[8397993708429497603]]#[[6504254477]]
        LOCATE BEFORE ALL
        INSERT {
            signal tocShowView()
            signal tocAddEntry(~&7083178290016&~ ~&7083037950451&~)
            signal tocAddCurrentEntry()
        }

        TRAVERSE [[6502786168]]#[[233745975898428]] > [[8398044571386570029]]
            LOCATE BEFORE [[7712155293725601]][.[[8399878573055752961]]=[["3575461827597527778]]]
            INSERT {
                ~&454089850271038938&~ {
                    ~&5972374&~: tocButton
                    ~&233745975898428&~: ~&6504254477&~
                    ~&6504337259&~: ~&454089850271038938&~.~&6503187275&~.~&14888501028015932088&~

                    ~&8399601734642709923&~: ~&"15094524446771854124&~
                    ~&233726547792244&~: ~&6504329801&~
                    ~&233748328658231&~: !!~&7712934851008712&~ && ~&6504254477&~.~&7712989577739634&~ &&
                             (~&7081905792137&~.~&214646099849&~ !== 954 ||
                              ~&6504254477&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&6502877684&~ ||
                              ~&6504254477&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&214602223655&~)
                    ~&214641332312&~: !!~&7712934851008712&~ &&
                           (~&7081905792137&~.~&214646099849&~ !== 954 ||
                            ~&6504254477&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&6502877684&~ ||
                            ~&6504254477&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&214602223655&~)

                    ~&254542253295368380&~: ~&6504254477&~.~&233718999756776&~(tocButton)

                    ~&6144132522167405889&~: ~&14125623155555875541&~ {
                        ~&233744706647566&~: 0

                        ~&425121728314878811&~.~&432643201877711221&~ {
                            ~&214632764553&~: ~&6504222003&~("Add ToC entry at page %1").~&197080195&~(~&477346483278306569&~ + 1)
                            ~&8399601734642709923&~: "qrc:/ark/icons/plus_small"
                            ~&254542236275632405&~: {
                                ~&6504254477&~.~&15738511857451076348&~();
                                ~&6504254477&~.tocAddEntry(~&15793094956877902211&~.~&3321486226208410902&~);
                            }
                        }

                        ~&254501108490678590&~ {
                            ~&7081629735527&~.~&254529418434902000&~: ~&6504329801&~
                            ~&7082729686082&~: 1
                            ~&214622605608&~: ~&7082020628281&~.colorMidGray
                            ~&233748328658231&~: ~&15793094956877902211&~.~&7713616698729984&~.~&7082886407723&~ > 0
                        }

                        ~&425121728314878811&~.~&432643201877711221&~ {
                            ~&214632764553&~: ~&6504222003&~("Show Table of Contents")
                            ~&8399601734642709923&~: ~&"15094524446771854124&~
                            ~&233748328658231&~: ~&15793094956877902211&~.~&7713616698729984&~.~&7082886407723&~ > 0
                            ~&254542236275632405&~: {
                                ~&6504254477&~.~&15738511857451076348&~();
                                ~&6504254477&~.tocShowView();
                            }
                        }
                    }
                }
            }
        END TRAVERSE
    END TRAVERSE
END AFFECT

; Paper Pro Move SettingsMenu (3.22)
AFFECT [[2719823753422213979]]
    IMPORT QtQuick.Window 2.0
    TRAVERSE [[454089850271038938]]#[[6504254477]] > [[254480451320573660]]#[[16710723433319324941]] > [[14125623155555875541]]#[[233724020048228]]
        LOCATE AFTER [[10944793121199847949]]
        INSERT {
            ~&425121728314878811&~.~&432643201877711221&~ {
                ~&214632764553&~: ~&6504222003&~("Add ToC entry at page %1").~&197080195&~(~&6504254477&~.~&477346483278306569&~ + 1)
                ~&8399601734642709923&~: "qrc:/ark/icons/plus_small"
                ~&233748328658231&~: ~&7081905792137&~.~&214646099849&~ === 954 &&
                         ~&6504329801&~ &&
                         (~&6504254477&~.~&233745975898428&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&197065948&~ ||
                          ~&6504254477&~.~&233745975898428&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&7081254810046&~)
                ~&254542236275632405&~: {
                    ~&6504254477&~.~&233745975898428&~.~&15738511857451076348&~();
                    ~&6504254477&~.~&233745975898428&~.tocAddCurrentEntry();
                }
            }

            ~&425121728314878811&~.~&432643201877711221&~ {
                ~&214632764553&~: ~&6504222003&~("Show Table of Contents")
                ~&8399601734642709923&~: ~&"15094524446771854124&~
                ~&233748328658231&~: ~&7081905792137&~.~&214646099849&~ === 954 &&
                         ~&15793094956877902211&~.~&7713616698729984&~.~&7082886407723&~ > 0 &&
                         (~&6504254477&~.~&233745975898428&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&197065948&~ ||
                          ~&6504254477&~.~&233745975898428&~.~&7713446884515614&~ === ~&8236974744924391272&~.~&7712083094340350&~.~&7081254810046&~)
                ~&254542236275632405&~: {
                    ~&6504254477&~.~&233745975898428&~.~&15738511857451076348&~();
                    ~&6504254477&~.~&233745975898428&~.tocShowView();
                }
            }
        }
    END TRAVERSE
END AFFECT
